name: CI

# Triggers: Pull requests and manual dispatch
on:
    pull_request:
    workflow_dispatch:

# Build pipeline: nanus -> rivus -> artifex
# Each stage depends on artifacts from the previous stage
jobs:
    # Stage 1: Build nanus bootstrap compilers
    # Output: nanus executables
    build-nanus:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - run: bun install --frozen-lockfile
            - run: bun run build:nanus-ts
            - uses: actions/upload-artifact@v4
              with:
                  name: opus-nanus
                  path: opus/

    # Stage 2: Build rivus compiler (via nanus-ts)
    # Input: nanus executables
    # Output: rivus executable
    build-rivus:
        needs: build-nanus
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - run: bun install --frozen-lockfile
            - uses: actions/download-artifact@v4
              with:
                  name: opus-nanus
                  path: opus/
            - run: chmod +x opus/bin/nanus-ts
            - run: bun run build:rivus
            - uses: actions/upload-artifact@v4
              with:
                  name: opus-rivus
                  path: opus/

    # Stage 3: Build artifex (rivus compiling itself)
    # Input: rivus executable
    # Output: final self-hosted compiler
    build-artifex:
        needs: build-rivus
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - run: bun install --frozen-lockfile
            - uses: actions/download-artifact@v4
              with:
                  name: opus-rivus
                  path: opus/
            - run: chmod +x opus/bin/rivus
            - run: bun run build:artifex
            - uses: actions/upload-artifact@v4
              with:
                  name: opus-artifex
                  path: opus/
