name: CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  build-norma:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build:norma
      - uses: actions/upload-artifact@v4
        with:
          name: norma-generated
          path: |
            fons/norma/index.json
            fons/rivus/codegen/norma-registry.gen.fab

  build-faber:
    needs: build-norma
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          name: norma-generated
      - run: cp norma/index.json fons/norma/ && cp rivus/codegen/norma-registry.gen.fab fons/rivus/codegen/
      - run: bun run build:faber
      - uses: actions/upload-artifact@v4
        with:
          name: opus-faber
          path: opus/
      - uses: actions/upload-artifact@v4
        with:
          name: faber-generated
          path: fons/faber/codegen/norma.gen.ts

  build-rivus:
    needs: build-faber
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          name: opus-faber
          path: opus/
      - uses: actions/download-artifact@v4
        with:
          name: norma-generated
      - uses: actions/download-artifact@v4
        with:
          name: faber-generated
      - run: cp norma/index.json fons/norma/ && cp rivus/codegen/norma-registry.gen.fab fons/rivus/codegen/ && cp norma.gen.ts fons/faber/codegen/
      - run: bun run build:rivus
      - uses: actions/upload-artifact@v4
        with:
          name: opus-rivus
          path: opus/

  build-artifex:
    needs: build-rivus
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          name: opus-rivus
          path: opus/
      - uses: actions/download-artifact@v4
        with:
          name: norma-generated
      - uses: actions/download-artifact@v4
        with:
          name: faber-generated
      - run: cp norma/index.json fons/norma/ && cp rivus/codegen/norma-registry.gen.fab fons/rivus/codegen/ && cp norma.gen.ts fons/faber/codegen/
      - run: chmod +x opus/bin/rivus
      - run: bun run build:artifex
      - uses: actions/upload-artifact@v4
        with:
          name: opus-artifex
          path: opus/

