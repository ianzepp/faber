#!/usr/bin/env bash
# Rivus - Bootstrap compiler CLI wrapper
#
# Provides faber-compatible interface for the bootstrap compiler.
# Currently supports: compile <file> [-o output] [-t target]
#
# Usage:
#   bun run rivus compile input.fab              # Output TS to stdout
#   bun run rivus compile input.fab -t go        # Output Go to stdout
#   bun run rivus compile input.fab -o out.ts    # Output to file
#   cat input.fab | bun run rivus compile -      # Read from stdin
set -euo pipefail

cd "$(dirname "$0")/.."

if [[ $# -lt 1 ]]; then
    echo "Usage: rivus <command> [options]" >&2
    echo "" >&2
    echo "Commands:" >&2
    echo "  compile <file> [-o output] [-t target]   Compile .fab file" >&2
    echo "  check <file>                             Check syntax (not implemented)" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  -t, --target   Target language: ts (default), go" >&2
    echo "  -o, --output   Output file (default: stdout)" >&2
    exit 1
fi

command="$1"
shift

case "$command" in
    compile)
        if [[ $# -lt 1 ]]; then
            echo "Error: compile requires a file argument" >&2
            exit 1
        fi

        input="$1"
        shift

        output=""
        target="ts"
        while [[ $# -gt 0 ]]; do
            case "$1" in
                -o|--output)
                    output="$2"
                    shift 2
                    ;;
                -t|--target)
                    target="$2"
                    shift 2
                    ;;
                *)
                    echo "Unknown option: $1" >&2
                    exit 1
                    ;;
            esac
        done

        # Handle stdin ("-") or file input
        if [[ "$input" == "-" ]]; then
            # Read from stdin, no file path
            if [[ -n "$output" ]]; then
                FAB_TARGET="$target" bun opus/rivus/fons/ts/cli.ts > "$output"
                echo "Compiled: stdin -> $output ($target)" >&2
            else
                FAB_TARGET="$target" bun opus/rivus/fons/ts/cli.ts
            fi
        else
            # Get absolute path for module resolution
            abs_input="$(cd "$(dirname "$input")" && pwd)/$(basename "$input")"

            if [[ -n "$output" ]]; then
                { echo "$abs_input"; cat "$input"; } | FAB_TARGET="$target" bun opus/rivus/fons/ts/cli.ts > "$output"
                echo "Compiled: $input -> $output ($target)" >&2
            else
                { echo "$abs_input"; cat "$input"; } | FAB_TARGET="$target" bun opus/rivus/fons/ts/cli.ts
            fi
        fi
        ;;
    
    check)
        echo "Error: check command not yet implemented in rivus" >&2
        exit 1
        ;;
    
    *)
        echo "Unknown command: $command" >&2
        exit 1
        ;;
esac
