#!/usr/bin/env bash
# Build, version bump, and release faber
set -euo pipefail

cd "$(dirname "$0")/.."

# Parse arguments
BUMP="minor"
FORCE=false
for arg in "$@"; do
    case $arg in
        --major) BUMP="major" ;;
        --minor) BUMP="minor" ;;
        --patch) BUMP="patch" ;;
        --force) FORCE=true ;;
        *) echo "Unknown argument: $arg"; exit 1 ;;
    esac
done

# Preflight checks
if [[ $(git branch --show-current) != "main" ]]; then
    echo "Error: Must be on main branch"
    exit 1
fi

if [[ -n $(git status --porcelain) ]]; then
    echo "Error: Working tree is dirty. Commit or stash changes first."
    exit 1
fi

echo "=== Running tests ==="
if [[ "$FORCE" == true ]]; then
    bun test || echo "Warning: Tests failed but --force was specified, continuing..."
else
    bun test
fi

echo "=== Building faber ==="
bun run build

echo "=== Verifying exempla ==="
bun run verify:exempla

# Read current version
CURRENT=$(jq -r .version package.json)
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

# Bump version
case $BUMP in
    major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
    minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
    patch) PATCH=$((PATCH + 1)) ;;
esac

VERSION="${MAJOR}.${MINOR}.${PATCH}"
echo "=== Bumping version: $CURRENT â†’ $VERSION ==="

# Update package.json
jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp
mv package.json.tmp package.json

# Commit and tag
git add package.json
git commit -m "Release v${VERSION}"
git tag "v${VERSION}"

echo "=== Pushing to origin ==="
git push -u origin main
git push --tags

echo "=== Creating GitHub release ==="
gh release create "v${VERSION}" opus/faber --title "v${VERSION}" --notes "Release v${VERSION}"

echo "=== Released v${VERSION} ==="
