# caelum.fab - Network Socket Device (TCP/UDP)
#
# Etymology: "caelum" - sky, ether. The transport layer beneath HTTP.
#            Counterpart to solum (ground/local I/O).
#
# Part of the Hardware Abstraction Layer (HAL).
# For HTTP, see http.fab.
#
# Design notes:
#   - TCP: ausculta (listen), connecta (connect)
#   - Sockets are bidirectional byte streams
#   - All operations are async

@ subsidia ts "codegen/ts/caelum.ts"
pactum caelum {
    # =========================================================================
    # TCP SERVER
    # =========================================================================

    # Create TCP listener on port
    @ futura
    @ externa
    functio ausculta(numerus portus) -> Auscultator

    # Create TCP listener with TLS
    @ futura
    @ externa
    functio auscultaTls(numerus portus, textus certPath, textus keyPath) -> Auscultator

    # =========================================================================
    # TCP CLIENT
    # =========================================================================

    # Connect to TCP server
    @ futura
    @ externa
    functio connecta(textus hospes, numerus portus) -> Connexus

    # Connect with TLS
    @ futura
    @ externa
    functio connectaTls(textus hospes, numerus portus) -> Connexus

    # =========================================================================
    # UDP
    # =========================================================================

    # Create UDP socket bound to port
    @ futura
    @ externa
    functio bindUdp(numerus portus) -> SocketumUdp

    # Send UDP datagram (unconnected)
    @ futura
    @ externa
    functio mitteUdp(textus hospes, numerus portus, octeti data) -> vacuum
}

# TCP Listener
pactum Auscultator {
    # Accept next incoming connection
    @ futura
    @ externa
    functio accipe() -> Connexus

    # Stop listening
    @ externa
    functio claude() -> vacuum

    # Local port
    @ externa
    functio portus() -> numerus
}

# TCP Socket (connected)
pactum Connexus {
    # Read bytes (blocks until data available)
    @ futura
    @ externa
    functio lege() -> octeti

    # Read up to n bytes
    @ futura
    @ externa
    functio legeUsque(numerus n) -> octeti

    # Write bytes
    @ futura
    @ externa
    functio scribe(octeti data) -> vacuum

    # Close connection
    @ externa
    functio claude() -> vacuum

    # Remote address
    @ externa
    functio hospesRemotus() -> textus

    # Remote port
    @ externa
    functio portusRemotus() -> numerus

    # Local address
    @ externa
    functio hospesLocalis() -> textus

    # Local port
    @ externa
    functio portusLocalis() -> numerus
}

# UDP Socket
pactum SocketumUdp {
    # Receive datagram (returns data and sender info)
    @ futura
    @ externa
    functio recipe() -> DatumUdp

    # Send datagram to address
    @ futura
    @ externa
    functio mitte(textus hospes, numerus portus, octeti data) -> vacuum

    # Close socket
    @ externa
    functio claude() -> vacuum

    # Local port
    @ externa
    functio portus() -> numerus
}

# UDP Datagram
pactum DatumUdp {
    @ externa
    functio data() -> octeti

    @ externa
    functio hospes() -> textus

    @ externa
    functio portus() -> numerus
}
