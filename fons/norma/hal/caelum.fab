# caelum.fab - Network Socket Device (TCP/UDP)
#
# Etymology: "caelum" - sky, ether. The transport layer beneath HTTP.
#            Counterpart to solum (ground/local I/O).
#
# Part of the Hardware Abstraction Layer (HAL).
# For HTTP, see http.fab.
#
# Design notes:
#   - Verb conjugation encodes sync/async:
#     - Imperative (-a, -e, -i): synchronous (blocking)
#     - Future indicative (-et, -ebit): asynchronous
#   - TLS enabled via optional cert/key params (listen) or tute flag (connect)
#   - TCP: ausculta/auscultabit (listen), connecte/connectet (connect)
#   - Sockets are bidirectional byte streams

@ subsidia ts "codegen/ts/caelum.ts"
pactum caelum {
    # =========================================================================
    # TCP SERVER
    # =========================================================================

    # Create TCP listener (TLS when cert/key provided)
    @ externa
    functio ausculta(numerus portus, si textus cert, si textus key) -> Auscultator

    @ futura
    @ externa
    functio auscultabit(numerus portus, si textus cert, si textus key) -> Auscultator

    # =========================================================================
    # TCP CLIENT
    # =========================================================================

    # Connect to TCP server (TLS when tute=verum)
    @ externa
    functio connecte(textus hospes, numerus portus, si bivalens tute vel falsum) -> Connexus

    @ futura
    @ externa
    functio connectet(textus hospes, numerus portus, si bivalens tute vel falsum) -> Connexus
}

# TCP Listener
pactum Auscultator {
    # Accept next incoming connection
    @ externa
    functio accipe() -> Connexus

    @ futura
    @ externa
    functio accipiet() -> Connexus

    # Stop listening
    @ externa
    functio claude() -> vacuum

    # Local port
    @ externa
    functio portus() -> numerus
}

# TCP Socket (connected byte stream)
pactum Connexus {
    # Draw bytes (up to n if provided, otherwise whatever is available)
    @ externa
    functio hauri(si numerus n) -> octeti

    @ futura
    @ externa
    functio hauriet(si numerus n) -> octeti

    # Pour bytes
    @ externa
    functio funde(octeti data) -> vacuum

    @ futura
    @ externa
    functio fundet(octeti data) -> vacuum

    # Close connection
    @ externa
    functio claude() -> vacuum

    # Remote address
    @ externa
    functio hospesRemotus() -> textus

    # Remote port
    @ externa
    functio portusRemotus() -> numerus

    # Local address
    @ externa
    functio hospesLocalis() -> textus

    # Local port
    @ externa
    functio portusLocalis() -> numerus
}

# TODO: UDP support deferred
# pactum SocketumUdp { ... }
# pactum DatumUdp { ... }
