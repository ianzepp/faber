# arca.fab - Database Device
#
# Etymology: "arca" - chest, strongbox, treasury. Where data is stored.
#
# Part of the Hardware Abstraction Layer (HAL).
#
# Design notes:
#   - Connection via URL: postgres://, mysql://, sqlite:///path, sqlite://:memory:
#   - Verb conjugation encodes sync/async and cardinality:
#     - Future singular (-et): async, returns one value
#     - Future plural (-ent): async generator, yields multiple values
#   - Parameterized queries prevent SQL injection

@ subsidia ts "../../norma-ts/hal/arca.ts"
pactum arca {
    # =========================================================================
    # CONNECTION
    # =========================================================================

    # Connect to database (driver inferred from URL scheme)
    # URLs: postgres://, mysql://, sqlite:///path, sqlite://:memory:
    @ futura
    @ externa
    functio connectet(textus url) -> Connexio
}

# Database connection
pactum Connexio {
    # =========================================================================
    # QUERIES
    # =========================================================================

    # Stream rows as async generator
    @ futura
    @ cursor
    @ externa
    functio quaerent(textus sql, lista<quidlibet> params) -> cursor<series>

    # Return all rows as list
    @ futura
    @ externa
    functio quaeret(textus sql, lista<quidlibet> params) -> lista<series>

    # Return first row or nihil
    @ futura
    @ externa
    functio capiet(textus sql, lista<quidlibet> params) -> series?

    # =========================================================================
    # MUTATIONS
    # =========================================================================

    # Execute INSERT/UPDATE/DELETE, return affected row count
    @ futura
    @ externa
    functio exsequetur(textus sql, lista<quidlibet> params) -> numerus

    # Execute INSERT, return last inserted ID
    @ futura
    @ externa
    functio inseret(textus sql, lista<quidlibet> params) -> numerus

    # =========================================================================
    # TRANSACTIONS
    # =========================================================================

    # Begin transaction
    @ futura
    @ externa
    functio incipiet() -> Transactio

    # =========================================================================
    # LIFECYCLE
    # =========================================================================

    # Close connection
    @ externa
    functio claude() -> vacuum

    # Check if connection is open
    @ externa
    functio aperta() -> bivalens
}

# Database transaction
pactum Transactio {
    # Stream rows as async generator
    @ futura
    @ cursor
    @ externa
    functio quaerent(textus sql, lista<quidlibet> params) -> cursor<series>

    # Return all rows as list
    @ futura
    @ externa
    functio quaeret(textus sql, lista<quidlibet> params) -> lista<series>

    # Execute mutation within transaction
    @ futura
    @ externa
    functio exsequetur(textus sql, lista<quidlibet> params) -> numerus

    # Commit transaction
    @ futura
    @ externa
    functio committet() -> vacuum

    # Rollback transaction
    @ futura
    @ externa
    functio revertet() -> vacuum
}
