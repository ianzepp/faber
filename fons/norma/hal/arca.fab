# arca.fab - Database Device
#
# Etymology: "arca" - chest, strongbox, treasury. Where data is stored.
#
# Part of the Hardware Abstraction Layer (HAL).
# Maps to StorageEngine from monk-os-kernel (structured key-value with transactions).
#
# Design notes:
#   - Connection via URL: postgres://, mysql://, sqlite:///path
#   - Query returns cursor for streaming large result sets
#   - Transactions via incipe/committe/reverte
#   - Parameterized queries prevent SQL injection

@ subsidia ts "codegen/ts/arca.ts"
pactum arca {
    # =========================================================================
    # CONNECTION
    # =========================================================================

    # Connect to database (driver inferred from URL scheme)
    @ futura
    @ externa
    functio connecta(textus url) -> Connexio

    # Connect to SQLite file (convenience)
    @ futura
    @ externa
    functio sqlite(textus path) -> Connexio

    # Connect to in-memory SQLite (for testing)
    @ futura
    @ externa
    functio memoria() -> Connexio
}

# Database connection
pactum Connexio {
    # =========================================================================
    # QUERIES
    # =========================================================================

    # Execute SELECT, return cursor over rows
    @ futura
    @ externa
    functio quaere(textus sql, lista<quidlibet> params) -> cursor<series>

    # Execute SELECT, return all rows as list
    @ futura
    @ externa
    functio quaereOmnes(textus sql, lista<quidlibet> params) -> lista<series>

    # Execute SELECT, return first row or nihil
    @ futura
    @ externa
    functio quaerePrimum(textus sql, lista<quidlibet> params) -> series?

    # Execute SELECT, return single value from first row
    @ futura
    @ externa
    functio quaereValorem(textus sql, lista<quidlibet> params) -> quidlibet

    # =========================================================================
    # MUTATIONS
    # =========================================================================

    # Execute INSERT/UPDATE/DELETE, return affected row count
    @ futura
    @ externa
    functio exsequi(textus sql, lista<quidlibet> params) -> numerus

    # Execute INSERT, return last inserted ID
    @ futura
    @ externa
    functio insere(textus sql, lista<quidlibet> params) -> numerus

    # =========================================================================
    # TRANSACTIONS
    # =========================================================================

    # Begin transaction
    @ futura
    @ externa
    functio incipe() -> Transactio

    # =========================================================================
    # LIFECYCLE
    # =========================================================================

    # Close connection
    @ externa
    functio claude() -> vacuum

    # Check if connection is open
    @ externa
    functio aperta() -> bivalens
}

# Database transaction
pactum Transactio {
    # Query within transaction
    @ futura
    @ externa
    functio quaere(textus sql, lista<quidlibet> params) -> cursor<series>

    @ futura
    @ externa
    functio quaereOmnes(textus sql, lista<quidlibet> params) -> lista<series>

    # Execute within transaction
    @ futura
    @ externa
    functio exsequi(textus sql, lista<quidlibet> params) -> numerus

    # Commit transaction
    @ futura
    @ externa
    functio committe() -> vacuum

    # Rollback transaction
    @ futura
    @ externa
    functio reverte() -> vacuum
}
