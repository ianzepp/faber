# Target Capability System - Support matrix and lowering models
#
# Defines which Faber language features are supported by each compilation target.
# Used by the validation phase to detect incompatibilities before codegen runs.
#
# ARCHITECTURE
# ============
# Support levels:
# - Sustentum: Native, faithful implementation with correct semantics
# - Emulatum: Systematic transform (e.g., Result<T,E> for exceptions)
# - Discrepans: Can be "made to work" but semantics differ (dangerous)
# - Insustentum: Cannot be emitted without breaking semantics

# =============================================================================
# SUPPORT LEVELS
# =============================================================================

# Support level for a language feature in a target
@ publica
ordo Sustentatio {
    Sustentum       # Native, faithful implementation
    Emulatum        # Systematic transform (polyfill)
    Discrepans      # Semantic mismatch (dangerous)
    Insustentum     # Cannot be emitted
}

# =============================================================================
# CAPABILITY STRUCTURES
# =============================================================================

# Control flow capabilities
@ publica
genus ControlFlowCapacitas {
    Sustentatio asyncFunctio        # futura
    Sustentatio generatorFunctio    # cursor / fiunt
    Sustentatio asyncGenerator      # futura cursor / fient
}

# Error handling capabilities
@ publica
genus ErrorCapacitas {
    Sustentatio temptaCape          # tempta...cape
    Sustentatio iace                # iace (throw)
}

# Binding pattern capabilities
@ publica
genus LigaturaCapacitas {
    Sustentatio seriesDestructura   # fixum [a, b] = ...
    Sustentatio obiectumDestructura # ex obj fixum {x, y}
}

# Parameter capabilities
@ publica
genus ParametrumCapacitas {
    Sustentatio valorPraedefinitus  # functio f(numerus x vel 0)
}

# Expression capabilities
@ publica
genus ExpressiaCapacitas {
    Sustentatio optivumAccessus     # ?. optional chaining
    Sustentatio coalescentio        # ?? null coalescing
}

# Complete target support matrix
@ publica
genus TargetCapacitas {
    ControlFlowCapacitas controlFlow
    ErrorCapacitas errores
    LigaturaCapacitas ligatura
    ParametrumCapacitas parametra
    ExpressiaCapacitas expressiae
}

# =============================================================================
# LOWERING MODELS
# =============================================================================

# How nihil/ignotum are represented
@ publica
ordo NullabilisModel {
    Innatum         # builtin null/undefined
    Optio           # Option<T> / optional wrapper
    Indicator       # pointer/nil
}

# Primary error model
@ publica
ordo ErrorModel {
    Exceptiones     # try/catch/throw
    Resultatum      # Result<T, E>
    MultipleReditus # (val, error) returns
    Unio            # error unions
}

@ publica
genus TargetLowering {
    NullabilisModel nullabilis
    ErrorModel errores
}

# =============================================================================
# TARGET SUPPORT MATRICES
# =============================================================================

# TypeScript - full support for all features
@ publica
fixum CAPACITAS_TS = {
    controlFlow: {
        asyncFunctio: Sustentatio.Sustentum,
        generatorFunctio: Sustentatio.Sustentum,
        asyncGenerator: Sustentatio.Sustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Sustentum,
        iace: Sustentatio.Sustentum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Sustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Sustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Sustentum,
        coalescentio: Sustentatio.Sustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# Python - most features, no optional chaining
@ publica
fixum CAPACITAS_PY = {
    controlFlow: {
        asyncFunctio: Sustentatio.Sustentum,
        generatorFunctio: Sustentatio.Sustentum,
        asyncGenerator: Sustentatio.Sustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Sustentum,
        iace: Sustentatio.Sustentum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Insustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Sustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Insustentum,
        coalescentio: Sustentatio.Insustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# Rust - async yes, generators no, Result for errors
@ publica
fixum CAPACITAS_RS = {
    controlFlow: {
        asyncFunctio: Sustentatio.Sustentum,
        generatorFunctio: Sustentatio.Insustentum,
        asyncGenerator: Sustentatio.Insustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Emulatum,
        iace: Sustentatio.Emulatum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Sustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Insustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Insustentum,
        coalescentio: Sustentatio.Insustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# Zig - no async, no generators, error unions
@ publica
fixum CAPACITAS_ZIG = {
    controlFlow: {
        asyncFunctio: Sustentatio.Insustentum,
        generatorFunctio: Sustentatio.Insustentum,
        asyncGenerator: Sustentatio.Insustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Emulatum,
        iace: Sustentatio.Emulatum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Insustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Insustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Insustentum,
        coalescentio: Sustentatio.Discrepans
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# C++ - no async/generators, exceptions yes
@ publica
fixum CAPACITAS_CPP = {
    controlFlow: {
        asyncFunctio: Sustentatio.Insustentum,
        generatorFunctio: Sustentatio.Insustentum,
        asyncGenerator: Sustentatio.Insustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Sustentum,
        iace: Sustentatio.Sustentum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Insustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Sustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Insustentum,
        coalescentio: Sustentatio.Insustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# Faber (self-compile) - full support
@ publica
fixum CAPACITAS_FAB = {
    controlFlow: {
        asyncFunctio: Sustentatio.Sustentum,
        generatorFunctio: Sustentatio.Sustentum,
        asyncGenerator: Sustentatio.Sustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Sustentum,
        iace: Sustentatio.Sustentum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Sustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Sustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Sustentum,
        coalescentio: Sustentatio.Sustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# Go - GC'd, no async/generators, multi-return errors
@ publica
fixum CAPACITAS_GO = {
    controlFlow: {
        asyncFunctio: Sustentatio.Insustentum,
        generatorFunctio: Sustentatio.Insustentum,
        asyncGenerator: Sustentatio.Insustentum
    } novum ControlFlowCapacitas,
    errores: {
        temptaCape: Sustentatio.Emulatum,
        iace: Sustentatio.Emulatum
    } novum ErrorCapacitas,
    ligatura: {
        seriesDestructura: Sustentatio.Sustentum,
        obiectumDestructura: Sustentatio.Insustentum
    } novum LigaturaCapacitas,
    parametra: {
        valorPraedefinitus: Sustentatio.Insustentum
    } novum ParametrumCapacitas,
    expressiae: {
        optivumAccessus: Sustentatio.Insustentum,
        coalescentio: Sustentatio.Insustentum
    } novum ExpressiaCapacitas
} novum TargetCapacitas

# =============================================================================
# LOWERING MODELS
# =============================================================================

@ publica
fixum LOWERING_TS = {
    nullabilis: NullabilisModel.Innatum,
    errores: ErrorModel.Exceptiones
} novum TargetLowering

@ publica
fixum LOWERING_PY = {
    nullabilis: NullabilisModel.Innatum,
    errores: ErrorModel.Exceptiones
} novum TargetLowering

@ publica
fixum LOWERING_RS = {
    nullabilis: NullabilisModel.Optio,
    errores: ErrorModel.Resultatum
} novum TargetLowering

@ publica
fixum LOWERING_ZIG = {
    nullabilis: NullabilisModel.Optio,
    errores: ErrorModel.Unio
} novum TargetLowering

@ publica
fixum LOWERING_CPP = {
    nullabilis: NullabilisModel.Optio,
    errores: ErrorModel.Exceptiones
} novum TargetLowering

@ publica
fixum LOWERING_FAB = {
    nullabilis: NullabilisModel.Innatum,
    errores: ErrorModel.Exceptiones
} novum TargetLowering

@ publica
fixum LOWERING_GO = {
    nullabilis: NullabilisModel.Indicator,
    errores: ErrorModel.MultipleReditus
} novum TargetLowering

# =============================================================================
# LOOKUP FUNCTIONS
# =============================================================================

# Get capability matrix for a target
@ publica
functio getCapacitas(de textus target) -> TargetCapacitas {
    elige target {
        casu "ts" { redde CAPACITAS_TS }
        casu "py" { redde CAPACITAS_PY }
        casu "rs" { redde CAPACITAS_RS }
        casu "zig" { redde CAPACITAS_ZIG }
        casu "cpp" { redde CAPACITAS_CPP }
        casu "fab" { redde CAPACITAS_FAB }
        casu "faber" { redde CAPACITAS_FAB }
        casu "glyph" { redde CAPACITAS_FAB }
        casu "go" { redde CAPACITAS_GO }
        ceterum { redde CAPACITAS_TS }
    }
}

# Get lowering model for a target
@ publica
functio getLowering(de textus target) -> TargetLowering {
    elige target {
        casu "ts" { redde LOWERING_TS }
        casu "py" { redde LOWERING_PY }
        casu "rs" { redde LOWERING_RS }
        casu "zig" { redde LOWERING_ZIG }
        casu "cpp" { redde LOWERING_CPP }
        casu "fab" { redde LOWERING_FAB }
        casu "faber" { redde LOWERING_FAB }
        casu "glyph" { redde LOWERING_FAB }
        casu "go" { redde LOWERING_GO }
        ceterum { redde LOWERING_TS }
    }
}
