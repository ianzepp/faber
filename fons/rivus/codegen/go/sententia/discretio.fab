# Go Statement Generator - Discretio (Tagged Unions)
#
# Generates Go interface + struct types for discriminated unions.
#
# TRANSFORMS:
#   discretio Event { Click { numerus x, numerus y }, Quit }
#   ->
#   type Event interface {
#       isEvent()
#   }
#   type Click struct {
#       X int64
#       Y int64
#   }
#   func (Click) isEvent() {}
#   type Quit struct{}
#   func (Quit) isEvent() {}

importa ex "../../../ast/sententia" privata VariansDeclaratio
importa ex "../../../ast/sententia" privata Visibilitas
importa ex "../nucleus" privata GoGenerator
importa ex "../typus" privata genTypus

@ publica
functio genDiscretio(in GoGenerator g, de textus nomen, de lista<VariansDeclaratio> variantes, si de ignotum generaParametra, si de ignotum visibilitas) -> textus {
    varia lines = [] innatum lista<textus>

    # Generate marker method name (lowercase for unexported)
    fixum markerMethod = scriptum("is§", nomen)

    # Generate interface type
    lines.appende(scriptum("§type § interface {", g.ind(), nomen))
    g.intraProfundum()
    lines.appende(scriptum("§§()", g.ind(), markerMethod))
    g.exiProfundum()
    lines.appende(scriptum("§}", g.ind()))

    # Generate struct types and marker implementations for each variant
    itera ex variantes fixum varians {
        lines.appende("")  # Blank line between types

        si varians.campi.longitudo() == 0 {
            # Unit variant: empty struct
            lines.appende(scriptum("§type § struct{}", g.ind(), varians.nomen))
        } secus {
            # Variant with fields
            lines.appende(scriptum("§type § struct {", g.ind(), varians.nomen))
            g.intraProfundum()
            itera ex varians.campi fixum campus {
                fixum fieldName = capitaliza(campus.nomen)
                fixum fieldType = genTypus(g, campus.typus)
                lines.appende(scriptum("§§ §", g.ind(), fieldName, fieldType))
            }
            g.exiProfundum()
            lines.appende(scriptum("§}", g.ind()))
        }

        # Marker method implementation
        lines.appende(scriptum("§func (§) §() {}", g.ind(), varians.nomen, markerMethod))
    }

    redde lines.coniunge("\n")
}

# Capitalize first letter for Go field names
functio capitaliza(de textus s) -> textus {
    si s.longitudo() == 0 {
        redde s
    }
    fixum primum = s.sectio(0, 1) qua textus
    fixum first = primum.maiuscula()
    si s.longitudo() == 1 {
        redde first
    }
    redde scriptum("§§", first, s.sectio(1, s.longitudo()))
}
